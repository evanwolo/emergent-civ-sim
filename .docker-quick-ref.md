# Docker Quick Reference

## Essential Commands

### Build
```bash
docker build -t grand-strategy-kernel:latest .
```

### Run Interactive
```bash
docker run -it --rm -v $(pwd)/data:/app/data grand-strategy-kernel:latest
```

### Run Batch
```bash
echo "run 1000 10" | docker run -i --rm -v $(pwd)/data:/app/data grand-strategy-kernel:latest
```

### Docker Compose
```bash
# Interactive
docker compose up kernel

# Batch mode
docker compose --profile batch up batch

# Stop
docker compose down
```

## Example Workflows

### 1. Quick Test
```bash
# Build and test
docker build -t grand-strategy-kernel:latest .
echo "metrics" | docker run -i --rm grand-strategy-kernel:latest
```

### 2. Development Iteration
```bash
# Make changes to source
# Rebuild
docker build -t grand-strategy-kernel:dev .

# Test
echo -e "step 100\nmetrics" | docker run -i --rm grand-strategy-kernel:dev
```

### 3. Production Run
```bash
# Run 10,000 ticks with logging
mkdir -p data
echo "run 10000 100" | docker run -i --rm \
  -v $(pwd)/data:/app/data \
  grand-strategy-kernel:latest

# Check output
cat data/metrics.csv | tail -20
```

### 4. Export Snapshot
```bash
# Run and export final state
echo -e "run 1000 10\nstate traits" | docker run -i --rm \
  -v $(pwd)/data:/app/data \
  grand-strategy-kernel:latest > data/final_state.json
```

### 5. Multi-Stage Pipeline
```bash
# Stage 1: Warm-up period
echo "run 500 50" | docker run -i \
  --name sim-warmup \
  -v $(pwd)/data:/app/data \
  grand-strategy-kernel:latest

# Stage 2: Main simulation
docker commit sim-warmup grand-strategy-kernel:warmup
echo "run 5000 100" | docker run -i --rm \
  -v $(pwd)/data:/app/data \
  grand-strategy-kernel:warmup

# Cleanup
docker rm sim-warmup
```

## Windows PowerShell Syntax

```powershell
# Build
docker build -t grand-strategy-kernel:latest .

# Run interactive
docker run -it --rm -v ${PWD}/data:/app/data grand-strategy-kernel:latest

# Run batch
echo "run 1000 10" | docker run -i --rm -v ${PWD}/data:/app/data grand-strategy-kernel:latest

# Docker Compose
docker compose up kernel
```

## Troubleshooting

### Container exits immediately
```bash
# Check logs
docker logs <container_id>

# Run with shell
docker run -it --rm --entrypoint /bin/bash grand-strategy-kernel:latest
```

### Permission issues on data folder
```bash
# Linux/Mac: Fix permissions
sudo chown -R $(id -u):$(id -g) data/

# Or run as root (not recommended)
docker run -it --rm --user root -v $(pwd)/data:/app/data grand-strategy-kernel:latest
```

### Out of memory
```bash
# Increase memory limit
docker run -it --rm --memory="4g" -v $(pwd)/data:/app/data grand-strategy-kernel:latest
```

## Registry Publishing

### Docker Hub
```bash
# Tag
docker tag grand-strategy-kernel:latest username/grand-strategy-kernel:0.2.0
docker tag grand-strategy-kernel:latest username/grand-strategy-kernel:latest

# Login and push
docker login
docker push username/grand-strategy-kernel:0.2.0
docker push username/grand-strategy-kernel:latest
```

### GitHub Container Registry
```bash
# Tag
docker tag grand-strategy-kernel:latest ghcr.io/username/grand-strategy-kernel:latest

# Login and push
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
docker push ghcr.io/username/grand-strategy-kernel:latest
```

### Private Registry
```bash
# Tag
docker tag grand-strategy-kernel:latest registry.company.com/sim/kernel:latest

# Push
docker push registry.company.com/sim/kernel:latest
```

See `DOCKER.md` for comprehensive deployment documentation.
